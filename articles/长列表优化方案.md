# é•¿åˆ—è¡¨ä¼˜åŒ–æ–¹æ¡ˆè§£æ

ğŸ‘‰ [react-infinite-auto-scroller](https://github.com/sansui-orz/react-infinite-auto-scroller)

æ—¥å¸¸å·¥ä½œä¸­ï¼Œç»å¸¸é‡åˆ°é•¿åˆ—è¡¨ï¼ˆå•†å“åˆ—è¡¨ï¼Œç¤¾åŒºå¸–å­åˆ—è¡¨ï¼ŒåŠ¨æ€åˆ—è¡¨ï¼Œè§†é¢‘æµâ€¦â€¦ï¼‰ã€‚æ‰€ä»¥ä¹Ÿäº†è§£å½“ç”¨æˆ·åˆ·åˆ°äº†å¤§é‡å†…å®¹æ—¶ï¼Œç”±äºDOMæ•°é‡æ¿€å¢ï¼Œé¡µé¢çš„æ€§èƒ½é¢ä¸´çš„æŒ‘æˆ˜ã€‚

è€Œå¯¹é•¿åˆ—è¡¨çš„ä¼˜åŒ–åº“ä¹Ÿæœ‰å¾ˆå¤šï¼Œä½†æ˜¯å®é™…åº”ç”¨åˆ°é¡¹ç›®ä¸­å¤§å¤šåˆä¸åŒ¹é…ï¼Œè¦ä¹ˆå›ºå®šé«˜åº¦ï¼Œè¦ä¹ˆéœ€è¦å®šåˆ¶é€»è¾‘ã€‚æ‰€ä»¥æˆ‘ä»¬å°±è‡ªå·±æ‰‹åŠ¨å†™ä¸€éé•¿åˆ—è¡¨çš„ä¼˜åŒ–ï¼Œäº†è§£ä¼˜åŒ–æ¦‚å¿µä»¥åŠå…¶ä¸­çš„é—®é¢˜ã€‚

é¦–å…ˆæˆ‘ä»¬å…ˆæ­å»ºä¸€ä¸ªç®€æ˜“çš„åˆ—è¡¨ç»„ä»¶

æ–°å»ºlist.tsx

```tsx
import React, { Component } from 'react';
import Item from '../item';

export default class List extends Component<{}, {
  list: Array<{ text: string; img?: string; }>
}> {
  private refList = React.createRef<HTMLDivElement>();

  private lock = false;

  state = {
    list: [],
  };
  
  componentDidMount() {
    this.setState({
      list: this.getList(50),
    });
    window.addEventListener('scroll', this.listenScroll, false); // ç›‘å¬æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œè¿›è¡Œè§¦åº•åŠ è½½
  }

  componentWillUnmount() {
    window.removeEventListener('scroll', this.listenScroll, false); // å¸è½½æ—¶ç§»é™¤äº‹ä»¶ç›‘å¬
  }

  render() {
    return (
      <div className="list" ref={this.refList}>
        <div className="count">{this.state.list.length}</div>
        {this.state.list.map((item: { text: string; img?: string; }, index) => {
          return (
            <Item key={index} text={item.text} img={item.img} /> // åˆ—è¡¨é¡¹ï¼Œè¿™é‡Œåé¢éœ€è¦æ›´æ¢ç§°æ— é™æ»šåŠ¨ç»„ä»¶
          );
        })}
      </div>
    );
  }

  private listenScroll = () => { // ç›‘å¬æ˜¯å¦åˆ°åº•éƒ¨
    if (this.lock) return;
    // é˜²æŠ–
    this.lock = true;
    setTimeout(() => {
      this.lock = false;
    }, 100);
    const targetEle = this.refList?.current;
    if (targetEle) {
      const { bottom } = targetEle.getBoundingClientRect();
      // å¦‚æœè·ç¦»åº•éƒ¨è¿˜æœ‰åŠå±
      if (bottom < window.innerHeight * 1.5) {
        const list: Array<{ text: string; img?: string; }> = this.state.list;
        this.setState({
          list: list.concat(this.getList(50)),
        });
      }
    }
  };

  private getList(len: number) { // mockæ•°æ®æ¥å£è¯·æ±‚
    const list: Array<{ text: string; img?: string; }> = [];
    for (var i = 0; i < len; i++) {
      list.push(this.getItem());
    }
    return list;
  }

  private getItem(): { text: string, img?: string } {
    const t = 'é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰æ˜¯ React ä¸­ç”¨äºå¤ç”¨ç»„ä»¶é€»è¾‘çš„ä¸€ç§é«˜çº§æŠ€å·§ã€‚HOC è‡ªèº«ä¸æ˜¯ React API çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯ä¸€ç§åŸºäº React çš„ç»„åˆç‰¹æ€§è€Œå½¢æˆçš„è®¾è®¡æ¨¡å¼ã€‚';
    return {
      text: t.substr(Math.floor(Math.random() * t.length / 2), t.length / 2 + Math.floor(Math.random() * t.length / 2)), // éšæœºæˆªå–ä¸€æ®µæ–‡æœ¬
      img: Math.random() > 0.6 ? `http://iph.href.lu/200x${Math.floor(100 + Math.random() * 300)}` : '', // éšæœºæ·»åŠ ä¸€å¼ å›¾ç‰‡
    };
  }
}
```

æ–°å»ºitem.tsx

```tsx
import React, { Component } from 'react';

import './index.css';

interface IProps {
  text: string;
  img?: string;
}

class Item extends Component<IProps> {
  render() {
    const { text, img } = this.props;
    return (
      <div className="item">
        <div className="user">
          <img className="avatar" src={require('../../images/3.png').default} />
          <div className="username">123</div>
        </div>
        <p className="text">{text}</p>
        {img ? <img className="img" src={img} alt="" onLoad={this.imgLoad}/> : null}
        <div className="controls">
          <div className="action1">
            <img src={require('../../images/1.png').default} />
            0
          </div>
          <div className="action2">
            <img src={require('../../images/2.png').default} />
            0
          </div>
          <div className="action3">
            <img src={require('../../images/4.png').default} />
            0
          </div>
        </div>
      </div>
    );
  }

  private imgLoad = () => {}; // ç»™æ— é™æ»šåŠ¨ç»„ä»¶ç•™å‘
}


export default Item;
```

å¾…å®Œæˆã€‚
