# é•¿åˆ—è¡¨ä¼˜åŒ–æ–¹æ¡ˆè§£æ

ğŸ‘‰ [react-infinite-auto-scroller](https://github.com/sansui-orz/react-infinite-auto-scroller)

æ—¥å¸¸å·¥ä½œä¸­ï¼Œç»å¸¸é‡åˆ°é•¿åˆ—è¡¨ï¼ˆå•†å“åˆ—è¡¨ï¼Œç¤¾åŒºå¸–å­åˆ—è¡¨ï¼ŒåŠ¨æ€åˆ—è¡¨ï¼Œè§†é¢‘æµâ€¦â€¦ï¼‰ã€‚æ‰€ä»¥ä¹Ÿäº†è§£å½“ç”¨æˆ·åˆ·åˆ°äº†å¤§é‡å†…å®¹æ—¶ï¼Œç”±äºDOMæ•°é‡æ¿€å¢ï¼Œé¡µé¢çš„æ€§èƒ½é¢ä¸´çš„æŒ‘æˆ˜ã€‚

è€Œå¯¹é•¿åˆ—è¡¨çš„ä¼˜åŒ–åº“ä¹Ÿæœ‰å¾ˆå¤šï¼Œä½†æ˜¯å®é™…åº”ç”¨åˆ°é¡¹ç›®ä¸­å¤§å¤šåˆä¸åŒ¹é…ï¼Œè¦ä¹ˆå›ºå®šé«˜åº¦ï¼Œè¦ä¹ˆéœ€è¦å®šåˆ¶é€»è¾‘ã€‚æ‰€ä»¥æˆ‘ä»¬å°±è‡ªå·±æ‰‹åŠ¨å†™ä¸€éé•¿åˆ—è¡¨çš„ä¼˜åŒ–ï¼Œäº†è§£ä¼˜åŒ–æ¦‚å¿µä»¥åŠå…¶ä¸­çš„é—®é¢˜ã€‚

## æ„å»ºç®€æ˜“çš„åˆ—è¡¨

é¦–å…ˆæˆ‘ä»¬å…ˆæ­å»ºä¸€ä¸ªç®€æ˜“çš„åˆ—è¡¨ç»„ä»¶

æ–°å»ºlist.tsx

```tsx
import React, { Component } from 'react';
import Item from '../item';

export default class List extends Component<{}, {
  list: Array<{ text: string; img?: string; }>
}> {
  private refList = React.createRef<HTMLDivElement>();

  private lock = false;

  state = {
    list: [],
  };
  
  componentDidMount() {
    this.setState({
      list: this.getList(50),
    });
    window.addEventListener('scroll', this.listenScroll, false); // ç›‘å¬æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œè¿›è¡Œè§¦åº•åŠ è½½
  }

  componentWillUnmount() {
    window.removeEventListener('scroll', this.listenScroll, false); // å¸è½½æ—¶ç§»é™¤äº‹ä»¶ç›‘å¬
  }

  render() {
    return (
      <div className="list" ref={this.refList}>
        <div className="count">{this.state.list.length}</div>
        {this.state.list.map((item: { text: string; img?: string; }, index) => {
          return (
            <Item key={index} text={item.text} img={item.img} /> // åˆ—è¡¨é¡¹ï¼Œè¿™é‡Œåé¢éœ€è¦æ›´æ¢ç§°æ— é™æ»šåŠ¨ç»„ä»¶
          );
        })}
      </div>
    );
  }

  // ç®€å•å®ç°è§¦åº•åŠ è½½
  private listenScroll = () => { // ç›‘å¬æ˜¯å¦åˆ°åº•éƒ¨
    if (this.lock) return;
    // é˜²æŠ–
    this.lock = true;
    setTimeout(() => {
      this.lock = false;
    }, 100);
    const targetEle = this.refList?.current;
    if (targetEle) {
      const { bottom } = targetEle.getBoundingClientRect();
      // å¦‚æœè·ç¦»åº•éƒ¨è¿˜æœ‰åŠå±
      if (bottom < window.innerHeight * 1.5) {
        const list: Array<{ text: string; img?: string; }> = this.state.list;
        this.setState({
          list: list.concat(this.getList(50)),
        });
      }
    }
  };

  private getList(len: number) { // mockæ•°æ®æ¥å£è¯·æ±‚
    const list: Array<{ text: string; img?: string; }> = [];
    for (var i = 0; i < len; i++) {
      list.push(this.getItem());
    }
    return list;
  }

  private getItem(): { text: string, img?: string } {
    const t = 'é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰æ˜¯ React ä¸­ç”¨äºå¤ç”¨ç»„ä»¶é€»è¾‘çš„ä¸€ç§é«˜çº§æŠ€å·§ã€‚HOC è‡ªèº«ä¸æ˜¯ React API çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯ä¸€ç§åŸºäº React çš„ç»„åˆç‰¹æ€§è€Œå½¢æˆçš„è®¾è®¡æ¨¡å¼ã€‚';
    return {
      text: t.substr(Math.floor(Math.random() * t.length / 2), t.length / 2 + Math.floor(Math.random() * t.length / 2)), // éšæœºæˆªå–ä¸€æ®µæ–‡æœ¬
      img: Math.random() > 0.6 ? `http://iph.href.lu/200x${Math.floor(100 + Math.random() * 300)}` : '', // éšæœºæ·»åŠ ä¸€å¼ å›¾ç‰‡
    };
  }
}
```

æ–°å»ºitem.tsxï¼Œä¸ºäº†å°½é‡è¿˜åŸå®é™…åº”ç”¨åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥å°½é‡å¢åŠ ä¸€äº›å…ƒç´ ã€‚

```tsx
import React, { Component } from 'react';

import './index.css';

interface IProps {
  text: string;
  img?: string;
}

class Item extends Component<IProps> {
  render() {
    const { text, img } = this.props;
    return (
      <div className="item">
        <div className="user">
          <img className="avatar" src={require('../../images/3.png').default} />
          <div className="username">123</div>
        </div>
        <p className="text">{text}</p>
        {img ? <img className="img" src={img} alt=""/> : null}
        <div className="controls">
          <div className="action1">
            <img src={require('../../images/1.png').default} />
            0
          </div>
          <div className="action2">
            <img src={require('../../images/2.png').default} />
            0
          </div>
          <div className="action3">
            <img src={require('../../images/4.png').default} />
            0
          </div>
        </div>
      </div>
    );
  }
}


export default Item;
```

æ­¤æ—¶çš„åˆ—è¡¨çœ‹ä¸Šå»é•¿è¿™æ ·â¬‡ï¸

![åˆ—è¡¨](./imgs/20200729154731.jpg)

æ­¤æ—¶ï¼Œæˆ‘ä»¬åˆ—è¡¨æœ‰å¤šå°‘é¡¹ï¼Œå°±ä¼šæœ‰å¤šå°‘ä¸ªItemç»„ä»¶ã€‚

## ä¸ºä»€ä¹ˆä¼šå¡

æ¥ç€æˆ‘ä»¬æ¥è®¾è®¡é•¿åˆ—è¡¨ä¼˜åŒ–çš„é€»è¾‘ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ææ¸…æ¥šä¸ºä»€ä¹ˆåˆ—è¡¨é•¿äº†ä¼šå¡é¡¿ï¼Œæˆ‘æ€»ç»“äº†ä¸€ä¸‹æœ‰ä»¥ä¸‹ä¸¤ä¸ªåŸå› ï¼š

1. Reactæ¸²æŸ“åƒåŠ›ï¼Œå½“reactçš„è™šæ‹ŸDOMç»“æ„å¤æ‚æ—¶ï¼ŒDOMæ›´æ–°å°±ä¼šæ˜æ˜¾è€—æ—¶ï¼ˆå› ä¸ºDIFFç®—æ³•éœ€è¦éå†æ–°æ—§DOMç»“æ„ï¼‰

2. å¤§é‡DOMæ“ä½œï¼Œå³ä½¿æ˜¯React DiffèŠ‚ç‚¹é€Ÿåº¦å¤Ÿå¿«ï¼Œä½†æ˜¯æ¶‰åŠåˆ°å¤§é‡domèŠ‚ç‚¹å˜æ›´éœ€è¦ä¸domè¿›è¡Œäº¤äº’ï¼Œè¦çŸ¥é“domæ“ä½œéƒ½æ˜¯åŒæ­¥çš„ï¼Œä¸”domæ“ä½œè€—æ—¶å¹¶ä¼šé˜»å¡jså¾€ä¸‹æ‰§è¡Œï¼Œæ‰€ä»¥å½“å¤§é‡domäº¤äº’æ—¶ï¼Œé¡µé¢ä¼šå˜å¾—æ˜æ˜¾å¡é¡¿ã€‚

## è§£å†³æ–¹æ¡ˆ

é’ˆå¯¹é•¿åˆ—è¡¨å¡é¡¿æˆ‘ä»¬çŸ¥é“äº†åŸå› ï¼Œå°±å¯ä»¥é’ˆå¯¹æ€§çš„å¯¹å…¶è¿›è¡Œä¼˜åŒ–äº†ã€‚

ä»åŸå› æ¥çœ‹ï¼Œä¸»è¦é—®é¢˜åœ¨äºåˆ—è¡¨é•¿äº†ä¹‹åï¼ŒDOMç»“æ„çš„å¤æ‚åº¦å¢åŠ ï¼Œå¯¼è‡´jsè°ƒç”¨æ—¶é—´é•¿ï¼Œdomæ¸²æŸ“é¢‘ç¹ã€‚

### ç¬¬ä¸€ä¸ªæƒ³æ³•

æ—¢ç„¶æ˜¯å› ä¸ºdomç»“æ„å¤æ‚ï¼Œé‚£æˆ‘ä»¬å‡å°‘domæ•°é‡ä¸ç»“æ„ä¸å°±å¥½å’¯ã€‚æˆ‘è„‘ä¸­çš„ç¬¬ä¸€ä¸ªæƒ³æ³•æ˜¯è¿™æ ·çš„ï¼Œå¹¶ä¸”ç«‹å³å†™å‡ºäº†å¤§æ¦‚çš„è§£å†³æ–¹æ³•ã€‚

```tsx
const map = new Map();

const intersectionObserver = new IntersectionObserver((entrys) => {
    entrys.forEach((entry) => {
        const target = entry.target;
        const handle = map.get(target);
        handle && handle(entry.intersectionRadio > 0);
    });
}, { rootMargin: '50% 50% 50% 50%' });

export default function createInfiniteScrollItem(Component) {
  return class InfiniteScrollItem extends React.Component {
    state = {
      show: true,
      height: 0,
      ready: false,
    };

    private ref = React.createRef<HTMLDivElement>();

    componentDidMount() {
      const current = this.ref.current;
      map.set(current, (show: boolean) => {
        if (this.state.ready && show !== this.state.show) {
          this.setState({ show });
        }
      });
      intersectionObserver.observe(current);
    }

    componentWillUnmount() {
      const current = this.ref.current;
      intersectionObserver.unobserve(current);
      map.delete(current);
    }

    render() {
      return (
        <div ref={this.ref} style={{ height: this.state.height || 'auto' }}>
          {(this.state.show && this.state.ready) ? <Component {...this.props} infiniteReady={this.readyHandle} infiniteReportHeight={this.reportHeight}> : null}
        </div>
      );
    }

    private reportHeight = (height: number) => {
      this.setState({ height });
    };

    private readyHandle = () => {
      this.setState({ ready: true, show: this.getVisibility() });
    }

    private getVisibility = () => {
      const rect = this.ref.current.getBoundingClientRect();
      const wh = window.innerHeight;
      const ww = window.innerWidth;
      return rect.top > -0.5 * wh && rect.bottom < 1.5 * wh && rect.left  < 1.5 * ww && rect.right > -0.5 * ww;
    }
  }
}
```

è§£é‡Šä¸€ä¸‹ä¸Šé¢çš„ä»£ç 

1. é¦–å…ˆï¼Œå£°æ˜ä¸€ä¸ª`IntersectionObserver`å®ä¾‹æ¥ç›‘å¬èŠ‚ç‚¹çš„éšè—ä¸æ˜¾ç¤º

2. å£°æ˜ä¸€ä¸ªmapå¯¹è±¡å°†domå…ƒç´ ä¸å›è°ƒè¿›è¡Œå…³è”

3. å£°æ˜ä¸€ä¸ªé«˜é˜¶å‡½æ•°`createInfiniteScrollItem`ï¼Œç”¨æ¥åŒ…è£¹åˆ—è¡¨é¡¹ç»„ä»¶ï¼ŒåŒæ—¶æä¾›æ›å…‰æ˜¾ç¤ºï¼Œéšè—åˆ é™¤çš„é€»è¾‘

ä¸»è¦çš„é€»è¾‘éƒ½åœ¨é«˜é˜¶ç»„ä»¶é‡Œé¢ï¼Œè¯¥ç»„ä»¶ä»…ä»…åªæ˜¯ç»™åˆ—è¡¨é¡¹ç»„ä»¶åŒ…è£¹äº†ä¸€å±‚divï¼Œå€Ÿç€è¿™ä¸ªdivèŠ‚ç‚¹ï¼Œç›‘å¬å…¶éšè—ä¸æ˜¾ç¤ºï¼ŒåŒæ—¶å½“Componentå‡†å¤‡å®Œæ¯•æ—¶å¯ä»¥ä¸ŠæŠ¥ready, æ­¤æ—¶ç›‘å¬åˆ°èŠ‚ç‚¹æ˜¾ç¤ºéšè—æ˜¯æ‰ä¼šæ”¹å˜showå±æ€§ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“`infiniteReady`è°ƒç”¨æ˜¯ï¼Œè¯¥ç»„ä»¶å¯èƒ½å·²ç»å¤„äºéšè—çŠ¶æ€ï¼Œè€Œæ­¤æ—¶éœ€è¦ä¸»åŠ¨åˆ¤æ–­ä¸€ä¸‹å½“å‰å…ƒç´ çš„æ˜¾ç¤ºéšè—, å¦‚æœä¸è°ƒç”¨ï¼Œå°±åªèƒ½ç­‰åˆ°ä¸‹æ¬¡å…ƒç´ å¯è§æ€§å˜åŒ–æ—¶æ‰èƒ½èµ·æ•ˆï¼Œè¿™æ˜¯ä¸åˆç†çš„ã€‚

è€Œåˆ—è¡¨é¡¹ç»„ä»¶å†…ä¹Ÿéœ€è¦é€šè¿‡`infiniteReportHeight`æ–¹æ³•ä¸ŠæŠ¥é«˜åº¦ï¼Œåªæœ‰ä¸ŠæŠ¥é«˜åº¦çš„ç»„ä»¶æ‰èƒ½è¢«éšè—ï¼Œå› ä¸ºè¿™æ ·æ‰ä¸ä¼šå½±å“åˆ°é¡µé¢æ•´ä½“çš„å¸ƒå±€ã€‚

ç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ç»„ä»¶è¢«å¸è½½æ—¶æ³¨æ„å°†intersectionObserverä¸mapæ•°æ®æ¸…é™¤ï¼Œå¦åˆ™ä¼šå†…å­˜æ³„æ¼ã€‚

è¿™æ ·æˆ‘ä»¬å°±ç®€å•çš„å®ç°äº†ç¬¬ä¸€ä¸ªæ— é™åŠ è½½çš„ç»„ä»¶ï¼Œå½“æˆ‘ä»¬è¿è¡Œèµ·æ¥çš„æ—¶å€™ä¼šå‘ç°ï¼Œå¦‚æœæ˜¯æ»‘çš„æ…¢çš„è¯ï¼Œä¼¼ä¹æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å½“ä½ å¿«é€Ÿæ»‘åŠ¨æ—¶ï¼Œå°±ä¼šå‘ç°é¡µé¢å˜å¾—å¾ˆå¡ï¼Œæ¯”ä¼˜åŒ–å‰è¿˜è¦å¡ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

è¿™æ˜¯å› ä¸ºæˆ‘ä»¬é¢‘ç¹çš„è°ƒç”¨äº†setStateå»æ”¹å˜å˜åŒ–çš„ç»„ä»¶ï¼Œè¿™å°±å¯¼è‡´å½“å¿«é€Ÿæ»‘åŠ¨æ—¶ï¼Œä¸€ä¸‹å˜åŒ–çš„ç»„ä»¶å¤ªå¤šï¼Œå°±äº§ç”Ÿäº†å¾ˆå¤šçš„setStateï¼Œè¦çŸ¥é“setStateçš„æ—¶å€™å¹¶ä¸å•å•åªæ˜¯è°ƒç”¨ä¸€ä¸ªå‡½æ•°é‚£ä¹ˆç®€å•ï¼Œç”¨â€œå†°å±±ä¸€è§’â€æ¥å½¢å®¹è¿™ä¸ªæ–¹æ³•å†é€‚åˆä¸è¿‡äº†ã€‚

è¿™ä¹Ÿå°±å¯¼è‡´äº†å¤§é‡çš„setStateå¯¼è‡´äº†å¤§é‡jsè°ƒç”¨å †ç§¯ï¼Œå¯¼è‡´é¡µé¢å¡é¡¿ï¼Œå¤§é‡jså †ç§¯åˆä¼šå¯¼è‡´IntersectionObserveræ— æ³•è¢«è°ƒç”¨ï¼Œå› ä¸ºIntersectionObserveræ˜¯åœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰ä¼šè¢«è°ƒç”¨çš„ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¼šé‚£ä¹ˆå¡çš„åŸå› äº†ã€‚

æ‰€ä»¥è¿™ä¸ªæ–¹æ³•è¡¨é¢ä¸Šçœ‹ä¼¼ä¹è¡Œå¾—é€šï¼Œä½†æ˜¯å…¶å®æ˜¯ä¸å¯¹çš„ï¼Œå°¤å…¶æ˜¯å¤§é‡çš„setStateéƒ½æ˜¯å•ç‹¬çš„è°ƒç”¨ï¼Œå¹¶ä¸ä¼šè¢«åˆå¹¶ï¼Œæ€§èƒ½çš„æŸè€—æ˜¯æå¤§çš„ã€‚

é‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•èƒ½å¤Ÿåˆå¹¶setStateå‘¢ï¼Œç›®å‰æ¥çœ‹åªæœ‰åœ¨åŒä¸€ä¸ªclasså†…ï¼Œæˆ–è€…ä½¿ç”¨ç±»ä¼¼redux, mobxè¿™ç±»çš„ç¬¬ä¸‰æ–¹åº“æ‰èƒ½å®ç°äº†ã€‚

è€ƒè™‘åˆ°å¦‚æœä½¿ç”¨redux, mobxæ­¤ç±»çš„åº“ï¼Œè¿™ä¸ªå•çº¯çš„é¡¹ç›®å°±æ¯”è¾ƒé‡äº†ï¼Œæ„Ÿè§‰æ²¡ä»€ä¹ˆå¿…è¦ã€‚

é‚£ä¹ˆæ ¹æ®ä¼˜åŒ–ç›®æ ‡ï¼Œæˆ‘ä»¬æŠŠlistæŠ½åˆ°ä¸€ä¸ªç»„ä»¶å†…ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±ä¸èƒ½ç”¨ä¸€ä¸ªé«˜é˜¶å‡½æ•°æ¥å®ç°äº†ã€‚

æŠ½ç¦»å‡ºInfiniteScrollç»„ä»¶ã€‚

```tsx
export default class InfiniteScroll extends Component {
  render() {
    const list2 = this.sortList(this.state.list);
    return (
      <div className="infinite-scroll">
        {list2.map((item, index) => {
          const key = this.props.id ? item[this.props.id] : index;
          return (
            <InfiniteScrollItem
              key={}
              index={item.is_index}
              is_height={item.is_height}
              reportHeight={reportHeight}
              renderItem={this.renderItem}
              item={item}
            />
          );
        })}
      </div>
    );
  }
}
```

çœ‹ä¸Šé¢çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸ªsortListçš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ï¼Œä½¿ç”¨jsåˆ¤æ–­å“ªäº›ç»„ä»¶æ˜¯æ˜¾ç¤ºçš„ï¼Œå“ªäº›ç»„ä»¶æ˜¯éšè—çš„ã€‚

ä¸ºä»€ä¹ˆè¦ä½¿ç”¨jsåˆ¤æ–­å‘¢? å› ä¸ºjsè¿è¡Œé€Ÿåº¦å¿«ã€‚ã€‚ã€‚

å¾…ç»­ã€‚ã€‚ã€‚

## å…·ä½“å®ç°

## æ€»ç»“
